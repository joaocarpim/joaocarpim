name: Update Top Repositories
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get Top Repos
        run: |
          curl -s "https://api.github.com/users/joaocarpim/repos?per_page=100" \
          | jq -r '
            sort_by(-.stargazers_count)[:4]
            | .[]
            | "<a href=\"\(.html_url)\"><img src=\"https://github-readme-stats.vercel.app/api/pin/?username=joaocarpim&repo=\(.name)&theme=tokyonight&hide_border=true&border_radius=12\" /></a>"
          ' > top_repos.md

          # Formata em grade de 2x2
          echo "" > top_repos_section.md
          paste -d'\n' - - < top_repos.md | while IFS= read -r line1 && IFS= read -r line2; do
            echo "$line1 $line2"
          done >> top_repos_section.md

          # Fallback caso paste n√£o funcione: simplesmente usar o arquivo gerado
          if [ ! -s top_repos_section.md ]; then
            cp top_repos.md top_repos_section.md
          fi

      - name: Build Section
        run: |
          python3 << 'EOF'
          import json, subprocess, os

          result = subprocess.run(
              ['curl', '-s', 'https://api.github.com/users/joaocarpim/repos?per_page=100'],
              capture_output=True, text=True
          )
          repos = sorted(json.loads(result.stdout), key=lambda r: r.get('stargazers_count', 0), reverse=True)[:4]

          lines = []
          lines.append('<div align="center">')
          lines.append('')
          lines.append('| üì¶ Reposit√≥rio | ‚≠ê Stars | üç¥ Forks | üó£Ô∏è Linguagem |')
          lines.append('|:---|:---:|:---:|:---:|')

          for r in repos:
            name = r.get('name', '')
            url = r.get('html_url', '')
            stars = r.get('stargazers_count', 0)
            forks = r.get('forks_count', 0)
            lang = r.get('language') or '‚Äî'
            desc = (r.get('description') or '_Sem descri√ß√£o_')[:60]
            lines.append(f'| [**{name}**]({url}) <br/> <sub>{desc}</sub> | ‚≠ê {stars} | üç¥ {forks} | `{lang}` |')

          lines.append('')
          lines.append('</div>')
          lines.append('')

          # Adiciona os cards do github-readme-stats
          lines.append('<div align="center">')
          lines.append('')
          for i in range(0, len(repos), 2):
            row = repos[i:i+2]
            imgs = ' '.join(
              f'<a href="{r["html_url"]}"><img height="130" src="https://github-readme-stats.vercel.app/api/pin/?username=joaocarpim&repo={r["name"]}&theme=tokyonight&hide_border=true&border_radius=12" /></a>'
              for r in row
            )
            lines.append(imgs)
            lines.append('')

          lines.append('</div>')

          with open('top_repos.md', 'w') as f:
              f.write('\n'.join(lines))

          print("Se√ß√£o gerada com sucesso!")
          EOF

      - name: Replace Section
        run: |
          awk '/<!--TOP_REPOS_START-->/{print;system("cat top_repos.md");skip=1;next}
               /<!--TOP_REPOS_END-->/{skip=0}
               !skip' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Atualizando Top 4 Repos automaticamente üöÄ" || exit 0
          git push
